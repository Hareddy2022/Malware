import zlib
from Crypto.Cipher import AES
from Crypto.Util import Counter


KEY_LEN = 16


def aes_decrypt(enc_data, key):
    """Decrypt data"""
    counter = Counter.new(128, initial_value=0, little_endian=True)
    cypher = AES.new(key, AES.MODE_CTR, counter=counter)
    return cypher.decrypt(enc_data)


def aes_encrypt(data, key):
    """Encrypt data"""
    counter = Counter.new(128, initial_value=0, little_endian=True)
    cypher = AES.new(key, AES.MODE_CTR, counter=counter)
    return cypher.encrypt(data)


def decrypt_and_decompress(enc_data):
    """Decrypt and decompress data"""
    key = enc_data[-KEY_LEN:]
    pack_data = aes_decrypt(enc_data[:-KEY_LEN], key)
    return zlib.decompress(pack_data, -15)


if __name__ == '__main__':
    import sys
    import io
    import os

    if len(sys.argv) != 2:
        print('Usage:', os.path.basename(sys.argv[0]), 'filename')
        exit(0)

    file_name = sys.argv[1]

    with io.open(file_name, 'rb') as f:
        enc_data = f.read()

    data = decrypt_and_decompress(enc_data)

    new_file_name = file_name + '.dec'
    with io.open(new_file_name, 'wb') as f:
        f.write(data)

    print('Done!')
