/*
Akira ransomware
*/


rule Akira
{
    meta:
        author = "rivitna"
        family = "ransomware.akira.windows"
        description = "Akira ransomware Windows payload"
        severity = 10
        score = 100

    strings:
        $s0 = "\x00--encryption_path\x00" ascii
        $s1 = "\x00--share_file\x00" ascii
        $s2 = "\x00--encryption_percent\x00" ascii
        $s3 = "\x00Failed to read share files\x00" ascii
        $s4 = ":\\akira\\asio\\include\\" ascii
        $s5 = "\x00write_encrypt_info error: \x00" ascii
        $s6 = "\x00encrypt_part error: \x00" ascii
        $s7 = "\x00Trend Micro\x00" wide
        $s8 = " :Failed to make full encrypt\x00" wide
        $s9 = " :Failed to make spot encrypt\x00" wide
        $s10 = " :Failed to make part encrypt\x00" wide
        $s11 = " :Failed to write header\x00" wide
        $s12 = " :file rename failed. System error: \x00" wide

        $h0 = { 41 BA 05 00 00 00  // mov   r10d, 5
                41 80 FB 32        // cmp   r11b, 32h
                44 0F 42 D0        // cmovb r10d, eax
                33 D2              // xor   edx, edx
                48 8B C?           // mov   rax, rcx
                49 F7 F2           // div   r10
                4C 8B C8           // mov   r9, rax
                B9 02 00 00 00     // mov   ecx, 2
                41 B8 04 00 00 00  // mov   r8d, 4
                41 80 FB 32        // cmp   r11b, 32h
                44 0F 42 C1        // cmovb r8d, ecx
                41 8B C8           // mov   ecx, r8d
                48 0F AF C8        // imul  rcx, rax
                48 2B F9           // sub   rdi, rcx
                33 D2              // xor   edx, edx
                48 8B C7           // mov   rax, rdi
                49 F7 F2 }         // div   r10

    condition:
        ((uint16(0) == 0x5A4D) and (uint32(uint32(0x3C)) == 0x00004550)) and
        (
            (7 of ($s*)) or
            (1 of ($h*))
        )
}
